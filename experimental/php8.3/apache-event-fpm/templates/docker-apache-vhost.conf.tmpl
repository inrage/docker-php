<VirtualHost *:80>
    ServerAdmin webmaster@localhost
    DocumentRoot {{ getenv "APACHE_VHOST_DIR" "/var/www/html" }}
    ServerName default

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined

    <Directory "{{ getenv "APACHE_VHOST_DIR" "/var/www/html" }}">
        AllowOverride All
        Options -Indexes +FollowSymLinks -MultiViews
        Require all granted
    </Directory>

    #################################################################
    # PHP -> PHP-FPM (unix socket)
    #################################################################
    <FilesMatch "\.php$">
        SetHandler "proxy:unix:/var/run/php/php-fpm.sock|fcgi://localhost"
    </FilesMatch>

    # Hardening WP: pas de PHP dans uploads
    <Directory "{{ getenv "APACHE_VHOST_DIR" "/var/www/html" }}/wp-content/uploads">
        <FilesMatch "\.php$">
            Require all denied
        </FilesMatch>
    </Directory>

    #################################################################
    # Sécurité (Apache 2.4 natif)
    #################################################################
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>

    <FilesMatch "\.(?:sh|sql|mysql|po|tpl|make|test)$">
        Require all denied
    </FilesMatch>

    <FilesMatch "^Makefile$">
        Require all denied
    </FilesMatch>

    <LocationMatch "(^|/)\.">
        Require all denied
    </LocationMatch>

    RedirectMatch 404 ^/readme\.html$

    <Files "xmlrpc.php">
        Require all denied
    </Files>

    <LocationMatch "^/.*/\.git/">
        Require all denied
    </LocationMatch>

    <LocationMatch "^/wp-content/uploads/woocommerce_uploads/">
        Require all denied
    </LocationMatch>

    #################################################################
    # Cache HTTP
    #################################################################
    <IfModule mod_expires.c>
        ExpiresActive On

        ExpiresByType text/css              "access plus 1 year"
        ExpiresByType application/javascript "access plus 1 year"
        ExpiresByType application/x-javascript "access plus 1 year"
        ExpiresByType image/jpeg            "access plus 1 year"
        ExpiresByType image/png             "access plus 1 year"
        ExpiresByType image/gif             "access plus 1 year"
        ExpiresByType image/webp            "access plus 1 year"
        ExpiresByType image/svg+xml         "access plus 1 year"
        ExpiresByType font/woff             "access plus 1 year"
        ExpiresByType font/woff2            "access plus 1 year"
    </IfModule>

    <IfModule mod_headers.c>
        <LocationMatch "\.(?:css|js|jpe?g|png|gif|webp|svg|woff2?)$">
            Header set Cache-Control "public, max-age=31536000, immutable"
        </LocationMatch>

        <LocationMatch "\.(?:php|html?)$">
            Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
        </LocationMatch>
    </IfModule>

    SetEnvIf Request_URI "^/wp-cron\.php$" dontlog
    SetEnvIf Request_URI "^/wp-admin/admin-ajax\.php$" dontlog
    SetEnvIf Request_URI "^/wp-json/" dontlog
    LogFormat "%a %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" inrage

    CustomLog "/proc/self/fd/1" inrage env=!dontlog
    ErrorLog  "/proc/self/fd/2"
</VirtualHost>

